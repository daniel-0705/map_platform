<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">     
    <meta http-equiv="X-UA-Compatible" content="IE=edge">     
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <title>Explore</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkK5NajaFKNXkYT2WsdB96edSWRo5kYhY" async defer></script>
    <link rel="stylesheet" href="CSS/common.css" media="all">
    <script src="js/common.js"></script>
    <link rel="stylesheet" href="CSS/main_map.css" media="all">

    

    <script>
      //window.addEventListener("DOMContentLoaded", initMap);
      window.addEventListener("load", function(event){ initMap() }); 
      
      var map;
      var oms;                    //設定 spiderfy的全域變數
      var markers = [];           //map 上所有公開的地點
      var marker_content = {};    //將點擊到的地標資訊存在這裡
      var user_markers = [];      //使用者自己所有的地點

      function initMap() {
          //new map
          map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 25.033499866, lng: 121.558997764},
              zoom:15,
              options: {
                clickableIcons: true,
                mapTypeControl: false
              },
              styles: [
                {"elementType":"labels","stylers":[{"visibility":"off"}]},  //到時候要把這調成 off
                {"featureType": "road","elementType": "labels","stylers":[{"visibility":"on"}]},
                {"featureType": "transit.station","elementType": "labels","stylers":[{"visibility":"on"}]},
                {"featureType": "transit.station.bus","elementType": "labels","stylers":[{"visibility":"on"}]},
                {"featureType": "water","elementType": "labels","stylers":[{"visibility":"on"}]}
              ]
              
          });

          let xhr = new XMLHttpRequest();
          xhr.open("post", `/api/map`);
          xhr.setRequestHeader('Content-Type', 'application/json');

          let list_data = {
            type:"select",
            data:{
              access_token : localStorage.getItem("access_token")
            }
          }
          
          xhr.send(JSON.stringify(list_data));
          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let all_markers = JSON.parse(xhr.responseText);
              console.log(all_markers);

              let infoWindow = new google.maps.InfoWindow();
              oms = new OverlappingMarkerSpiderfier(map, {
                markersWontMove: true,
                markersWontHide: true,
                // basicFormatEvents: true,
                nearbyDistance : 1,
                circleSpiralSwitchover : Infinity,
                circleFootSeparation : 50
              });
              // all_marker_data
              for (let i = 0 ; i<all_markers.places.length ;i++){
              
                let marker = new google.maps.Marker({
                  position:{lat: Number(all_markers.places[i].latitude), lng: Number(all_markers.places[i].longitude)},
                  icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                    scaledSize: new google.maps.Size(100, 100)  //調整大小
                  },
                  map:map
                });
                // id = i 是用位置坐定位，當知道每個地點的順序後，因為公用地點的數量不會變，所以可以用位置來決定哪個地點 null
                marker.content = `
                  <h1 id =${i}>${all_markers.places[i].name}</h1>
                  <p>${all_markers.places[i].information}</p>
                  <buttom class = "choice_list" id =${all_markers.places[i].latitude}_${all_markers.places[i].longitude} style="cursor:pointer" onclick="select_list(this)">收藏</buttom>
                `;
                

                oms.addMarker(marker);
                google.maps.event.addListener(marker, 'spider_click', function () {
                  //收藏地點的 slidebar 即時顯示 點擊地標上的地名
                  let a_place_title = document.getElementsByClassName("a_place_title")[0];
                  a_place_title.innerHTML = all_markers.places[i].name;

                  //將點擊的地標資訊傳到外面的參數中
                  marker_content.name = all_markers.places[i].name;
                  marker_content.place_order = i;
                  marker_content.latitude = all_markers.places[i].latitude;
                  marker_content.longitude = all_markers.places[i].longitude;
                  marker_content.information = all_markers.places[i].information;
                  console.log(marker_content)
                  infoWindow.setContent(this.content);
                  infoWindow.open(this.getMap(), this);

                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });
                
                markers.push(marker);
              }
              for (let i = 0 ; i<all_markers.user_places.length ;i++){
                
                let marker = new google.maps.Marker({
                  position:{lat: Number(all_markers.user_places[i].latitude), lng: Number(all_markers.user_places[i].longitude)},
                  icon: {
                    url: `http://maps.google.com/mapfiles/ms/icons/${all_markers.user_places[i].list_icon}.png`
                    //scaledSize: new google.maps.Size(50, 50)  //調整大小
                  },
                  map:map
                });
                marker.content = `
                  <h1 id =${all_markers.user_places[i].place_order}>${all_markers.user_places[i].place_name}</h1>
                  <p id = ${i}>${all_markers.user_places[i].information}</p>
                  <buttom class = "choice_list" id =${all_markers.user_places[i].latitude}_${all_markers.user_places[i].longitude} style="cursor:pointer" onclick="select_list(this)">已收藏</buttom>
                `;
                oms.addMarker(marker);
                google.maps.event.addListener(marker, 'spider_click', function () {                   
                  //收藏地點的 slidebar 即時顯示 點擊地標上的地名
                  let a_place_title = document.getElementsByClassName("a_place_title")[0];
                  a_place_title.innerHTML = all_markers.user_places[i].place_name;

                  
                  //將點擊的地標資訊傳到外面的參數中
                  marker_content.name = all_markers.user_places[i].place_name;
                  marker_content.place_order = all_markers.user_places[i].place_order;
                  marker_content.user_place_order = i,
                  marker_content.latitude = all_markers.user_places[i].latitude;
                  marker_content.longitude = all_markers.user_places[i].longitude;
                  marker_content.information = all_markers.user_places[i].information;
                  console.log(marker_content)
                  infoWindow.setContent(this.content);
                  infoWindow.open(this.getMap(), this);

                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });
                markers[all_markers.user_places[i].place_order].setMap(null); //將相對應的公用地點 隱藏
                user_markers.push(marker);
              }

              google.maps.event.addListener(map, 'click', function () { 
                infoWindow.close();

                close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
              });
            }
          }
      }
      
      

      //選擇收藏後會出現清單選項
      function select_list(e){
        
        e.removeAttribute("onclick");
        // close_slidebar();

        document.getElementById("a_place").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";

        delete_child_element("a_place_content");

        let xhrt= new XMLHttpRequest();
        xhrt.open("post", "/api/user/map_list/result");  
        xhrt.setRequestHeader('Content-Type', 'application/json');
        
        let list_data ={
          type :"select",
          data : {
            access_token:localStorage.getItem("access_token"),
            place_name : marker_content.name
          }
        };

        xhrt.send(JSON.stringify(list_data));
        xhrt.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhrt.response);
            if(user_list_data.error){
                alert(user_list_data.error);
            }else{
              console.log(user_list_data);
              for (let i = 0 ;i<user_list_data.length;i++){
                //製作每一個 list 的內容 p
                let a_place_content = document.getElementsByClassName("a_place_content")[0]
                let list_cotainer = document.createElement("div");
                list_cotainer.className = "list_cotainer"
                a_place_content.appendChild(list_cotainer);

                let collection_button = document.createElement("button");
                if(user_list_data[i].check_place_is_exist == "true"){
                  collection_button.innerHTML = "移除";
                }else{
                  collection_button.innerHTML = "收藏";
                }
                collection_button.setAttribute("onClick", "store_place_in_list(this)");
                list_cotainer.appendChild(collection_button);

                let list_icon = document.createElement("img");
                list_icon.src = `http://maps.google.com/mapfiles/ms/icons/${user_list_data[i].list_icon}.png`
                list_cotainer.appendChild(list_icon);


                let new_list_name = document.createElement("p");
                new_list_name.className = "user_list";
                new_list_name.id = `${user_list_data[i].list_id}`;
                //new_list_name.setAttribute("onClick", "open_a_list(this)");
                new_list_name.innerHTML = user_list_data[i].list_name;
                list_cotainer.appendChild(new_list_name);
                
              }
            } 
          }
        }
      }

      function store_place_in_list(e){
        console.log(e)
        console.log(marker_content)

        let a_place_name = document.getElementById("a_place_name")

        let place_data ={
          access_token : localStorage.getItem("access_token"),
          list_name : e.parentElement.children[2].innerHTML,
          place_name : marker_content.name,
          place_order : marker_content.place_order,
          longitude : marker_content.longitude,
          latitude : marker_content.latitude,
          information : marker_content.information
        }

        console.log(place_data)

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/place");  
        xhr.setRequestHeader('Content-Type', 'application/json');

        if(e.innerHTML == "收藏"){
          let list_data = {
            type:"create",
            data:place_data
          }
          xhr.send(JSON.stringify(list_data));


          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_place_data = JSON.parse(xhr.response);
              if(user_place_data.error){
                alert(user_place_data.error);
              }else{  
                console.log(user_place_data);
                console.log(user_place_data.place_in_this_list);
                //新增收藏地點
                let marker = new google.maps.Marker({
                  position:{lat: place_data.latitude, lng: place_data.longitude},
                  icon: {
                    url: `http://maps.google.com/mapfiles/ms/icons/${user_place_data[0].list_icon}.png`
                  },
                  animation: google.maps.Animation.DROP,
                  //zIndex: 500,
                  map:map
                });

                let user_place_index = user_markers.length

                marker.content = `
                  <h1 id=${place_data.place_order}>${place_data.place_name}</h1>
                  <p id = ${user_place_index}>${place_data.information}</p>
                  <buttom class = "choice_list" id =${place_data.latitude}_${place_data.longitude} style="cursor:pointer" onclick="select_list(this)">已收藏</buttom>
                  `;
                let infoWindow = new google.maps.InfoWindow();

                let a_place_title = document.getElementsByClassName("a_place_title")[0];
                e.id = user_place_index;

                oms.addMarker(marker);
                google.maps.event.addListener(marker, 'spider_click', function (e) { 
                  //收藏地點的 slidebar 即時顯示 點擊地標上的地名
                  let a_place_title = document.getElementsByClassName("a_place_title")[0];
                  a_place_title.innerHTML = place_data.place_name;
                  console.log(e)
                  console.log(oms.getMarkers())
                  console.log(marker)
                  //將點擊的地標資訊傳到外面的參數中
                  marker_content.name = place_data.place_name;
                  marker_content.place_order = place_data.place_order;
                  marker_content.user_place_order = user_place_index,
                  marker_content.latitude = place_data.latitude;
                  marker_content.longitude = place_data.longitude;
                  marker_content.information = place_data.information;
                  
                  console.log(marker_content)
                  infoWindow.setContent(this.content);
                  infoWindow.open(this.getMap(), this);

                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });
                console.log(marker_content);

                infoWindow.close();
                google.maps.event.addListener(map, 'click', function () { 
                  infoWindow.close();

                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });

                //使用者按下收藏後，會顯現收藏的清單名稱及內容
                let new_a_list_name = document.getElementsByClassName("a_list_title")[0];
                new_a_list_name.value=user_place_data[0].list_name;
                delete_child_element("a_list_content");
                render_a_list_all_place(place_data);


                user_markers.push(marker);
                markers[marker_content.place_order].setMap(null); //把原本的地標 隱藏

              }
            }
          }
          e.innerHTML = "移除";
        }else{
          let list_data = {
            type:"delete",
            data:place_data
          }
          xhr.send(JSON.stringify(list_data));

          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_place_data = JSON.parse(xhr.response);
              if(user_place_data.error){
                alert(user_place_data.error);
              }else{
                console.log(user_place_data);

                if(user_place_data.check_place_is_exist == 0){
                  markers[marker_content.place_order].setMap(map); //把原本的地標 調回來
                }

                if (e.id == ""){
                  user_markers[marker_content.user_place_order].setMap(null); //把使用者先前存的的地標隱藏
                }else{
                  user_markers[e.id].setMap(null); //把使用者當下存的地標隱藏
                }
                
              }
            }
          }
          e.innerHTML = "收藏";
        }
      }



    </script>
    <script>

      function delete_child_element(parent_element){
        let parent_place = document.getElementsByClassName(parent_element)[0];
        console.log(parent_place)
        while (parent_place.hasChildNodes()) {
          parent_place.removeChild(parent_place.lastChild);
        }
      }

      function render_user_all_lists(){

        let xhrt= new XMLHttpRequest();
        xhrt.open("post", "/api/user/map_list/result");  
        xhrt.setRequestHeader('Content-Type', 'application/json');
        

        let list_data ={
          type :"select",
          data : {access_token:localStorage.getItem("access_token")}
        };

        //localStorage.getItem("access_token")
        xhrt.send(JSON.stringify(list_data));
        xhrt.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {

            if(xhrt.response == "error"){
                alert("查無此使用者，請註冊");
            }else{
              let user_list_data = JSON.parse(xhrt.response);
              console.log(user_list_data);
              for (let i = 0 ;i<user_list_data.length;i++){
                //製作每一個 list 的內容 p
                let new_list_name = document.createElement("p");
                new_list_name.className = "user_list_name";
                new_list_name.id = `${user_list_data[i].list_id}`;
                new_list_name.setAttribute("onClick", "open_a_list(this)");
                new_list_name.innerHTML = user_list_data[i].list_name;
                let list_content = document.getElementsByClassName("user_own_list_content")[0];
                list_content.appendChild(new_list_name);
                
              }
            }
              
          }
        }
      }
      
      function render_a_list_all_place(list){


        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/place");  
        xhr.setRequestHeader('Content-Type', 'application/json');

        let list_data = {
          type:"select",
          data:list
        }

        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_place_data = JSON.parse(xhr.response);
            if(user_place_data.error){
                alert(user_place_data.error);
            }else{
              console.log(user_place_data);

              //製作新的 place 的內容 p
              for(let i =0; i<user_place_data.length ; i++){     
                let new_place_name = document.createElement("p");
                new_place_name.className = "user_place_name";
                new_place_name.id = user_place_data[i].longitude+"_"+user_place_data[i].latitude
                new_place_name.innerHTML = user_place_data[i].place_name;
                new_place_name.setAttribute("onClick", "change_center_to_place(this)");
                let a_list_content = document.getElementsByClassName("a_list_content")[0];
                a_list_content.appendChild(new_place_name);
              }
            }
              
          }
        }

      }


      function open_slidebar() {

        close_slidebar();

        document.getElementById("search_and_list").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";

        //使用者跳出公開單一清單頁面時，要把座標跟值隱藏掉，所以在返回清單搜尋時要把值設回預設，不要顯示公開清單的地點
        user_public_list_markers.map(item=>{item.setMap(null)});
        user_public_list_markers=[];
        switch_for_public_list_map=1;

      }

      function close_slidebar() {
        document.getElementById("search_and_list").style.width = "0";
        document.getElementById("a_public_list").style.width = "0";
        document.getElementById("a_list").style.width = "0";
        document.getElementById("a_place").style.width = "0";
        document.getElementById("map").style.marginLeft= "0";
        
      }

      function open_list_input() {
        if(localStorage.getItem("access_token")== undefined){
          alert("! 欲使用此功能，請先登入");
        }else{
          document.getElementById("input_list_name").style.width = "100%";
        }
        
      }

      function close_list_input() {
        document.getElementById("input_list_name").style.width = "0";
      }

      function close_a_place_slidebar(){
        document.getElementById("a_place").style.width = "0px";

        if (document.getElementById("a_public_list").style.width == "" && document.getElementById("a_list").style.width == "" && document.getElementById("search_and_list").style.width == ""){
          document.getElementById("map").style.marginLeft = "0px";
        }

        if (document.getElementById("a_public_list").style.width == "0px" && document.getElementById("a_list").style.width == "0px" && document.getElementById("search_and_list").style.width == "0px"){
          document.getElementById("map").style.marginLeft = "0px";
        }

      }
      
      function reset_input(){
        document.querySelector('#list_name').value="";
        document.getElementById("reset").checked = true;
      }

      function send_list_name(){

        let insert_list ={
          category : document.querySelector('input[name="category"]:checked').value,
          list_name : document.getElementsByName("list_name")[0].value,
          list_icon : document.querySelector('input[name="pattern"]:checked').value,
          access_token : localStorage.getItem("access_token")
        }

        if (insert_list.list_name == "" || insert_list.list_name == undefined){
          alert("! 請輸入清單名稱");
          return;
        }

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"create",
          data:insert_list
        }

        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhr.response);
            if(user_list_data.error){
              alert(user_list_data.error);
            }else{
              
              console.log(user_list_data);
              
              delete_child_element("user_own_list_content")
              render_user_all_lists();
              close_list_input();
              reset_input();
            }
              
          }
        }
      }

      function open_a_list(e) {

        let new_a_list_name = document.getElementsByClassName("a_list_title")[0];
        new_a_list_name.value="";

        delete_child_element("a_list_content");

        close_slidebar();

        document.getElementById("a_list").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";
     
        new_a_list_name.id = e.id;
        new_a_list_name.className = "a_list_title";
        new_a_list_name.value = e.innerHTML;
        new_a_list_name.readOnly = true;

        let select_place ={
          access_token : localStorage.getItem("access_token"),
          list_name : e.innerHTML
        }
        console.log(select_place);

        render_a_list_all_place(select_place);

      }

  
      function delete_a_list(){
        let a_list_title = document.getElementsByClassName("a_list_title")[0];
        a_list_title.innerHTML = "";
        
        let delete_list ={
          list_id : a_list_title.id,
          list_name : a_list_title.value,
          access_token : localStorage.getItem("access_token")
        }

        let xhr = new XMLHttpRequest();

        xhr.open("post", "/api/user/map_list");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"delete",
          data:delete_list
        }
        console.log(list_data)
        xhr.send(JSON.stringify(list_data));
        
        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            if(xhr.response == "There is no user data."){
              alert("! 查無此使用者，請註冊");
            }else{
              let user_list_data = JSON.parse(xhr.response);
              console.log(user_list_data);

              close_slidebar();

              delete_child_element("user_own_list_content");
              markers=[]; //因為下一步要重新啟動 initMap ，所以 markers 要先清空，才不會重複算
              user_markers = []; //同上
              initMap();
              render_user_all_lists()
            } 
          }
        }

      }

      
      let switch_for_public_list_map;
      let user_public_list_markers=[];
      function show_and_open_public_list(e){

        console.log(e);

        close_slidebar();
        document.getElementById("a_public_list").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";

        if(switch_for_public_list_map !=0){
          
          let select_one_list={
            list_id:e.id,
            list_name:e.innerHTML
          }

          let xhr = new XMLHttpRequest();
          xhr.open("post", "/api/user/map_list/show/list");  
          xhr.setRequestHeader('Content-Type', 'application/json');
          
          let list_data = {
            type:"select",
            data:select_one_list
          }

          xhr.send(JSON.stringify(list_data));

          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_place_data = JSON.parse(xhr.response);
              if(user_place_data.error){
                  alert(user_place_data.error);
              }else{
                
                console.log(user_place_data);

                let a_public_list_name = document.getElementById("a_public_list_name");

                let public_list_name = document.querySelector("#a_public_list_name >p");

                public_list_name.innerHTML = e.innerHTML;
                public_list_name.id =e.id;
                public_list_name.setAttribute("onclick","show_and_open_public_list(this)")

                let list_owner = document.querySelector("#a_public_list_name >p:nth-child(2)");
                list_owner.innerHTML = user_place_data[0].user_name;

                let list_copy_img = document.querySelector("#a_public_list_name > img");
                list_copy_img.className = "list_copy_img";
                list_copy_img.src = "/img/multiple-users-silhouette.png"

                let list_copy_number = document.querySelector("#a_public_list_name >p:nth-child(4)");
                list_copy_number.innerHTML = e.parentElement.children[3].innerHTML;

                delete_child_element("a_public_list_content");
                
                //製作新的public place 的內容 p
                let parent_place = document.getElementsByClassName("a_public_list_content")[0]; 
                for(let i =0; i<user_place_data.length ; i++){     
                  let new_place_name = document.createElement("p");
                  new_place_name.className = "user_place_name";
                  new_place_name.innerHTML = user_place_data[i].place_name;
                  new_place_name.id = user_place_data[i].longitude+"_"+user_place_data[i].latitude
                  new_place_name.setAttribute("onClick", "change_center_to_place(this)");
                  parent_place.appendChild(new_place_name);
                }


                let infoWindow = new google.maps.InfoWindow();
                for(let i =0 ; i< user_place_data.length;i++){
                  //顯示公開的使用者的收藏地點
                  let marker = new google.maps.Marker({
                    position:{lat: Number(user_place_data[i].latitude), lng: Number(user_place_data[i].longitude)},
                    animation: google.maps.Animation.DROP,
                    zIndex: 500,
                    map:map
                  });

                  marker.content = `
                        <h1>${user_place_data[i].place_name}</h1>
                        <p>${user_place_data[i].information}</p>
                        `;

                  user_public_list_markers.push(marker);
                  oms.addMarker(marker);
                  google.maps.event.addListener(marker, 'spider_click', function () {                   
                    infoWindow.setContent(this.content);
                    infoWindow.open(this.getMap(), this);
                  });

                  
                  google.maps.event.addListener(map, 'click', function () { 
                    infoWindow.close();
                  });
                }
                
              }
            }
          }

          switch_for_public_list_map=0;
        }else{
          //使用者時，要把座標跟值隱藏掉，所以在返回清單搜尋時要把值設回預設，不要顯示公開清單的地點
          user_public_list_markers.map(item=>{item.setMap(null)});
          user_public_list_markers=[];
          switch_for_public_list_map=1;
        }





      }

      function copy_other_list(e){
        console.log(e);

        let a_public_list_name = e.parentElement.children[0];

        let a_public_list_owner = e.parentElement.children[1];

        console.log(a_public_list_name);
        console.log(a_public_list_owner);

        let copy_list={
          access_token : localStorage.getItem("access_token"),
          list_id : a_public_list_name.id,
          list_name : a_public_list_name.innerHTML,
          list_owner : a_public_list_owner.innerHTML
        }
        console.log(copy_list);
        

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/copy");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"copy",
          data:copy_list
        }

        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_place_data = JSON.parse(xhr.response);
            if(user_place_data.error){
              alert(user_place_data.error);
            }else{
             
              console.log(user_place_data);
              alert("複製成功")

              //製作新的 place 的內容 p
              // for(let i =0; i<user_place_data.length ; i++){     
              //   let new_place_name = document.createElement("p");
              //   new_place_name.className = "user_place_name";
              //   new_place_name.innerHTML = user_place_data[i].place_name;
              //   //new_place_name.setAttribute("onClick", "open_a_list(this)");
              //   let a_list_content = document.getElementsByClassName("a_list_content")[0];
              //   a_list_content.appendChild(new_place_name);
              // }
            }
              
          }
        }

      }

      function change_center_to_place(e){
        console.log(e)
        map.panTo({lat: Number(e.id.split("_")[1]), lng: Number(e.id.split("_")[0])});
      }
 

      render_user_all_lists()

    </script>
</head>
<body>
  <div class = "main">
    <nav>
      <div>
        <a href="/">
          <p id="logo" class="Logo">mapBook</p>
        </a>
      </div>
      <div>
        <ul>
            <li class="nav_item"><a href="/">About</a></li>
            <li class="nav_item"><a href="/main_map.html">Explore</a></li>
            <li class="nav_item" onclick="signin_or_profile()"><a>User</a></li>
        </ul>
      </div>
    </nav>

    <div class = "search_and_edit_bar">
        <button style="font-size:30px;cursor:pointer" onclick="open_slidebar()" >搜尋清單</button>
        <button style="font-size:30px;cursor:pointer" onclick="close_slidebar()" >關閉清單</button>
        <button style="font-size:30px;cursor:pointer" onclick="open_list_input()">新增清單</button>
    </div>
    

    <!-- 畫面外的新增清單 -->
    <div id="input_list_name" class="input_list_name">
      <a href="javascript:void(0)" class="close_button" onclick="close_list_input()">&times;</a>
      <input type="radio" name="category" value="true" checked > 公開<br>
      <input type="radio" name="category" value="false"> 私人<br>
      <input type="text" id = "list_name" name="list_name" placeholder="請輸入清單名稱"><br>
      <div>
        <p>清單地標樣式選擇</p>
        <input type="radio" id = "reset" name="pattern" value="red-dot" checked ><img src ="http://maps.google.com/mapfiles/ms/icons/red-dot.png">
        <input type="radio" name="pattern" value="red" ><img src ="http://maps.google.com/mapfiles/ms/icons/red.png">
        <input type="radio" name="pattern" value="yellow-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png">
        <input type="radio" name="pattern" value="yellow" ><img src ="http://maps.google.com/mapfiles/ms/icons/yellow.png"><br>
        <input type="radio" name="pattern" value="blue-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/blue-dot.png">
        <input type="radio" name="pattern" value="blue" ><img src ="http://maps.google.com/mapfiles/ms/icons/blue.png">
        <input type="radio" name="pattern" value="green-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/green-dot.png">
        <input type="radio" name="pattern" value="green" ><img src ="http://maps.google.com/mapfiles/ms/icons/green.png"><br>
        <input type="radio" name="pattern" value="ltblue-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/ltblue-dot.png">
        <input type="radio" name="pattern" value="lightblue" ><img src ="http://maps.google.com/mapfiles/ms/icons/lightblue.png">
        <input type="radio" name="pattern" value="orange-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/orange-dot.png">
        <input type="radio" name="pattern" value="orange" ><img src ="http://maps.google.com/mapfiles/ms/icons/orange.png"><br>
        <input type="radio" name="pattern" value="pink-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/pink-dot.png">
        <input type="radio" name="pattern" value="pink" ><img src ="http://maps.google.com/mapfiles/ms/icons/pink.png">
        <input type="radio" name="pattern" value="purple-dot" ><img src ="http://maps.google.com/mapfiles/ms/icons/purple-dot.png">
        <input type="radio" name="pattern" value="purple" ><img src ="http://maps.google.com/mapfiles/ms/icons/purple.png">
      </div>
      <button type="submit" onclick="send_list_name()")>Submit</button>
    </div>

    <!-- 畫面外的介面結束 -->

    <div class = "public_map">

      <!-- 畫面外的使用者單一清單介面  -->
      <div id ="a_list" class="a_list">
        <div id = "a_list_name" class="a_list_name">
          <input type="text" spellcheck="false" class="a_list_title" >
          <button style="font-size:10px;cursor:pointer" onclick="edit_a_list_name()">編輯名稱</button>
          <button style="font-size:10px;cursor:pointer" onclick="delete_a_list()">刪除清單</button>
        </div>
        <div class="a_list_content">
  
        </div>
      </div>
      <!-- 畫面外的介面結束 -->

      <!-- 畫面外的他人單一清單介面  -->
      <div id ="a_public_list" class="a_list">
          <div id = "a_public_list_name" class="a_list_name">
            <p style="cursor:pointer" class="a_list_title" ></p>
            <p></p>
            <img>
            <p></p>
            <button style="font-size:10px;cursor:pointer" onclick="copy_other_list(this)">複製</button>
          </div>
          <div class="a_public_list_content">
    
          </div>
        </div>
      <!-- 畫面外的介面結束 -->

      <!-- 畫面外的單一地點介面  -->
      <div id ="a_place" class="a_place">
        <div id = "a_place_name" class="a_place_name">
          <p class="a_place_title" ></p>
        </div>
        <div class="a_place_content">
  
        </div>
      </div>
      <!-- 畫面外的介面結束 -->




      <div class= "search_and_list" id="search_and_list">
        <div class = "search_list_bar">
          <input  id = "search" placeholder="Search list..." >
          <button class= "lsit_result" type ="button">搜尋</button>
        </div>

        <div class = "search_list_result">

        </div>
        


        <div class = "user_own_list">
          <div class = "user_own_list_title">
              <h1>my lists</h1>
          </div>
          <div class = "user_own_list_content" >

          </div>
        </div>
      </div>

      <div id="map">
      </div>

    

    </div>

    <footer>
        <div class="footer_bar">
          <div class="copyright">
              <p>© 2019. All rights reserved.</p>
          </div>
        </div>
    </footer>
  </div>
      

  <script>
    let list_name = document.getElementById("list_name");
    list_name.addEventListener("keyup", function(event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        send_list_name();
      }
    });

    let search_public_list_name = document.getElementById("search");
    search_public_list_name.addEventListener("keyup", function(event) {
    // Number 13 is the "Enter" key on the keyboard
      console.log(search_public_list_name)
      if (event.keyCode === 13) {
        event.preventDefault();
        
        delete_child_element("search_list_result");
        let grandpa_list_result = document.getElementsByClassName("search_list_result")[0];

        let xhr = new XMLHttpRequest();

        xhr.open("post", "/api/user/map_list/search/list");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"search",
          data:search_public_list_name.value
        }
        console.log(list_data)
        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            if(xhr.response == "There is no user data."){
              alert("! 查無此使用者，請註冊");
            }else{
              let user_list_data = JSON.parse(xhr.response);
              console.log(user_list_data);

              if(user_list_data.length == 0){
                let parent_list = document.createElement("p");
                parent_list.className = "no_public_list";
                parent_list.innerHTML = "查無清單，請換關鍵字搜尋"
                grandpa_list_result.appendChild(parent_list);

              }

              for (let i = 0 ;i<user_list_data.length;i++){
                //製作每一個 list 的內容 
                let parent_list = document.createElement("div");
                parent_list.className = "public_list_container";
                grandpa_list_result.appendChild(parent_list);

                let list_name = document.createElement("p");
                list_name.innerHTML = user_list_data[i].list_name;
                list_name.id =user_list_data[i].list_id;
                list_name.className = "public_list"
                list_name.setAttribute("onclick","show_and_open_public_list(this)")
                parent_list.appendChild(list_name);

                let list_owner = document.createElement("p");
                list_owner.innerHTML = user_list_data[i].user_name;
                parent_list.appendChild(list_owner);

                let list_copy_img = document.createElement("img");
                list_copy_img.className = "list_copy_img";
                list_copy_img.src = "/img/multiple-users-silhouette.png"
                parent_list.appendChild(list_copy_img);

                let list_copy_number = document.createElement("p");
                list_copy_number.innerHTML = user_list_data[i].copy_number;
                parent_list.appendChild(list_copy_number);
      
              }
            }             
          }
        }
      }
    });

    let a_list_title = document.getElementsByClassName("a_list_title")[0];
    function edit_a_list_name(){
      a_list_title.readOnly = "";
    }
    a_list_title.addEventListener("keyup", function(event) {
      // Number 13 is the "Enter" key on the keyboard
        if (event.keyCode === 13) {
          event.preventDefault();
          a_list_title.readOnly = true;

          let update_list ={
            list_id : a_list_title.id,
            list_name : a_list_title.value,
            access_token : localStorage.getItem("access_token")
          }

          let xhr = new XMLHttpRequest();

          xhr.open("post", "/api/user/map_list");  
          xhr.setRequestHeader('Content-Type', 'application/json');
          
          let list_data = {
            type:"update",
            data:update_list
          }
          console.log(list_data)
          xhr.send(JSON.stringify(list_data));

          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_list_data = JSON.parse(xhr.response);
              if(user_list_data.error){
                alert(user_list_data.error);
              }else{
                console.log(user_list_data);

                delete_child_element("user_own_list_content");

                render_user_all_lists()
              }
                
            }
          }
        }
      });

    let google_map = document.getElementById("map");
    google_map.addEventListener("click", function(event) {
    // Number 13 is the "Enter" key on the keyboard
    //document.getElementById("a_place").style.width = "0";


    });



  
  </script>

</body>



</html> 