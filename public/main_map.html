<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">     
    <meta http-equiv="X-UA-Compatible" content="IE=edge">     
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <title>Explore</title>
    <!-- logo 字體 -->
    <link href="https://fonts.googleapis.com/css?family=Fredericka+the+Great&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkK5NajaFKNXkYT2WsdB96edSWRo5kYhY" async defer></script>
    <link rel="stylesheet" href="CSS/common.css" media="all">
    
    <link rel="stylesheet" href="CSS/main_map.css" media="all">

    

    <script>
      //window.addEventListener("DOMContentLoaded", initMap);
      window.addEventListener("load", function(event){ initMap() }); 
      
      var map;
      var oms;                    //設定 spiderfy的全域變數
      var markers = [];           //map 上所有公開的地點
      var user_markers = [];      //使用者自己所有的地點
      var zoom;                   //設定 zoom 的全域變數
      var infoWindow;             //設定 infoWindow 的全域變數
      var search_marker;          //設定 搜尋的 marker 的全域變數

      function initMap() {
        //new map
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 25.033499866, lng: 121.558997764},
          zoom:13,
          options: {
            clickableIcons: true,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl:false,
          },
          styles: [
            {"elementType":"labels","stylers":[{"visibility":"off"}]},  //到時候要把這調成 off
            {"featureType": "road","elementType": "labels","stylers":[{"visibility":"on"}]},
            {"featureType": "transit.station","elementType": "labels","stylers":[{"visibility":"on"}]},
            {"featureType": "transit.station.bus","elementType": "labels","stylers":[{"visibility":"on"}]},
            {"featureType": "water","elementType": "labels","stylers":[{"visibility":"on"}]}
          ]

        });
        render_map_and_user_all_place();

        //依據 zoom 的大小 決定地圖顯示多少地標
        google.maps.event.addListener(map, 'zoom_changed', function() {
          zoom = map.getZoom();
          console.log(zoom);


          for (let i = 0; i<markers.length; i++){
            markers[i].setVisible(false);

            if (zoom > 12) {
              if(markers[i].category.includes("廢棄物處理場") || markers[i].category.includes("環境教育機構") || markers[i].category.includes("休閒農場")|| markers[i].category.includes("健康服務中心")|| markers[i].category.includes("藝文館所") || markers[i].category.includes("運動中心")){
                markers[i].setVisible(true);
              }
            }

            if (zoom > 13) {
              if(markers[i].category.includes("區公所")|| markers[i].category.includes("夜市")|| markers[i].category.includes("電影院")|| markers[i].category.includes("獨立書店")||markers[i].category.includes("博物館")||markers[i].category.includes("環保旅店")){
                markers[i].setVisible(true);
              }
            }
            if (zoom > 14) {
              if(markers[i].category.includes("圖書館")||markers[i].category.includes("文化資產")||markers[i].category.includes("郵局")||markers[i].category.includes("健康服務中心")){
                markers[i].setVisible(true);
              }
            }
            if (zoom > 15) {
              if(markers[i].category.includes("醫院")||markers[i].category.includes("診所")||markers[i].category.includes("牙醫")||markers[i].category.includes("電子遊戲場")||markers[i].category.includes("藥局")||markers[i].category.includes("眼科")||markers[i].category.includes("學校")||markers[i].category.includes("旅館")){
                markers[i].setVisible(true);
              }
            }

            if (zoom > 16) {
              if(markers[i].category.includes("社區資源回收站")||markers[i].category.includes("電動機車充電")||markers[i].category.includes("拖吊場")||markers[i].category.includes("護理所")||markers[i].category.includes("復健")){
                markers[i].setVisible(true);
              }
            }
          }
        });
      }
      

      //選擇收藏後會出現清單選項
      function select_list(e){
        if(localStorage.getItem("access_token")== undefined){
          alert("! 欲使用此功能，請先登入");
        }else{
          e.removeAttribute("onclick");
          // close_slidebar();

          console.log(e)
          console.log(e.parentElement.children[0].innerHTML)
          let a_place_title = document.getElementsByClassName("a_place_title")[0];
          
          a_place_title.innerHTML = e.parentElement.children[0].innerHTML;
          a_place_title.id = e.parentElement.children[0].id;

          document.getElementById("a_place").style.width = "300px";

          document.getElementById("map").style.marginLeft = "300px";
          document.getElementById("open_bar").style.marginLeft = "300px";
          document.getElementById("close_bar").style.marginLeft = "300px";
          document.getElementById("open_search_bar").style.marginLeft = "300px";

          delete_child_element("a_place_content");

          let list_data ={
            type :"select",
            data : {
              access_token:localStorage.getItem("access_token"),
              place_name : a_place_title.innerHTML
            }
          };
          render_collection_list_or_not(list_data);
        }
      }


      function delete_place_function(list_data){
        console.log(list_data)

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/place");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_place_data = JSON.parse(xhr.response);
            if(user_place_data.error){
              alert(user_place_data.error);
            }else{
              console.log(user_place_data);
              
              if(user_place_data.check_place_is_exist == 0){
                markers[list_data.data.place_order].setMap(map); //把原本的地標 調回來
              }


              //為了在搜尋列 顯示地點名稱時知道順序 所以只好用迴圈的方式找出該地名的順序
              let marker_order;
              for (let j =0 ; j <user_markers.length; j++){
                // console.log(list_data.data.place_name)
                // console.log(user_markers[j])
                if(user_markers[j].name == list_data.data.place_name && user_markers[j].list == list_data.data.list_name){
                  marker_order = j;
                  console.log(marker_order)
                }
              }


              user_markers[marker_order].setMap(null); //把使用者先前存的的地標隱藏

              let select_place ={
                access_token : localStorage.getItem("access_token"),
                list_name : list_data.data.list_name
              }
              //使用者按下移除後，會顯現收藏的清單名稱及內容
              delete_child_element("a_list_content");
              render_a_list_all_place_name(select_place);

              infoWindow.close(); //做完動作後要把地標視窗關掉
            }
          }
        }
      }

      function delete_user_place(e){
        // console.log(e);
        // console.log(e.parentElement.parentElement.parentElement.children[0].children[1].innerHTML);

        let place_data ={
          access_token : localStorage.getItem("access_token"),
          list_name : e.parentElement.parentElement.parentElement.children[0].children[1].innerHTML,
          place_name : e.parentElement.children[0].innerHTML,
          place_order : e.parentElement.children[0].id.split("_")[2]
        }

        let list_data = {
            type:"delete",
            data:place_data
        }

        console.log(place_data)

        delete_place_function(list_data);
      }


      function store_place_in_list(e){
        console.log(e);
        // console.log(e.parentElement.parentElement.parentElement.children[0].children[0].innerHTML);
        // console.log(e.parentElement.parentElement.parentElement.children[0].children[0].id);

        let a_place_name = document.getElementById("a_place_name")

        let place_data ={
          access_token : localStorage.getItem("access_token"),
          list_name : e.parentElement.children[1].innerHTML,
          place_name : e.parentElement.parentElement.parentElement.children[0].children[0].innerHTML,
          place_order : e.parentElement.parentElement.parentElement.children[0].children[0].id
        }



        console.log(place_data)

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/place");  
        xhr.setRequestHeader('Content-Type', 'application/json');

        if(e.innerHTML == "收藏"){
          let list_data = {
            type:"create",
            data:place_data
          }
          xhr.send(JSON.stringify(list_data));


          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_place_data = JSON.parse(xhr.response);
              if(user_place_data.error){
                alert(user_place_data.error);
              }else{  
                console.log(user_place_data);
                //新增收藏地點
                let marker = new google.maps.Marker({
                  position:{lat: Number(user_place_data[0].latitude), lng: Number(user_place_data[0].longitude)},
                  icon: {
                    url: `/img/${user_place_data[0].list_icon}.png`
                  },
                  animation: google.maps.Animation.DROP,
                  zIndex: 100000,
                  map:map
                });
                
                let user_place_index = user_markers.length
                
                //資訊是空的時候，不要顯示 null
                if(user_place_data[0].information == null){
                  user_place_data[0].information="";
                }

                marker.content = `
                  <div class = "infowindow_container">
                    <h1 class ="infowindow_title" id=${user_place_data[0].place_order}>${user_place_data[0].place_name}</h1>
                    <p class ="infowindow_content" id = ${user_place_index}>${user_place_data[0].information}</p>
                    <br>
                    <buttom class = "choice_list" id =${user_place_data[0].latitude}_${user_place_data[0].longitude} style="cursor:pointer" onclick="select_list(this)">已收藏</buttom>
                  </div>
                  `;
                infoWindow = new google.maps.InfoWindow();

                let a_place_title = document.getElementsByClassName("a_place_title")[0];
                e.id = user_place_index;  //判斷使用者新增的地點是排第幾個，方便之後 set null

                //定義每個地標屬於的清單
                marker.list = user_place_data[0].list_name
                //定義每個地標屬於的地名
                marker.name = user_place_data[0].place_name;

                oms.addMarker(marker);
                google.maps.event.addListener(marker, 'spider_click', function (e) { 

                  infoWindow.setContent(this.content);
                  infoWindow.open(this.getMap(), this);

                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });

                infoWindow.close();
                google.maps.event.addListener(map, 'click', function () { 
                  infoWindow.close();

                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });

                //使用者按下收藏後，會顯現收藏的清單名稱及內容
                let new_a_list_name = document.getElementsByClassName("a_list_title")[0];
                new_a_list_name.innerHTML=user_place_data[0].list_name;
                delete_child_element("a_list_content");
                render_a_list_all_place_name(place_data);
                
                
                user_markers.push(marker);
                markers[user_place_data[0].place_order].setMap(null); //把原本的地標 隱藏

              }
            }
          }
          e.innerHTML = "移除";
        }else{
          let list_data = {
            type:"delete",
            data:place_data
          }
          xhr.send(JSON.stringify(list_data));

          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_place_data = JSON.parse(xhr.response);
              if(user_place_data.error){
                alert(user_place_data.error);
              }else{
                console.log(user_place_data);
                console.log(place_data)
                if(user_place_data.check_place_is_exist == 0){
                  markers[place_data.place_order].setMap(map); //把原本的地標 調回來
                }

                //區別移除的點是當下存的還是之前存的
                if (e.id == ""){
                  console.log("先前存的的地點")

                  //為了在搜尋列 顯示地點名稱時知道順序 所以只好用迴圈的方式找出該地名的順序
                  let marker_order;
                  for (let j =0 ; j <user_markers.length; j++){
                    // console.log(place_data.place_name)
                    // console.log(user_markers[j])
                    if(user_markers[j].name == place_data.place_name){
                      marker_order = j;
                      console.log(marker_order)
                    }
                  }

                  user_markers[marker_order].setMap(null); //把使用者先前存的的地標隱藏
                  //使用者按下移除後，會顯現收藏的清單名稱及內容
                  delete_child_element("a_list_content");
                  render_a_list_all_place_name(place_data);

                  infoWindow.close();  //做完動作後要把地標視窗關掉
                }else{
                  console.log("當下存的地點")
                  user_markers[e.id].setMap(null); //把使用者當下存的地標隱藏

                  //使用者按下移除後，會顯現收藏的清單名稱及內容
                  delete_child_element("a_list_content");
                  render_a_list_all_place_name(place_data);

                  infoWindow.close(); //做完動作後要把地標視窗關掉
                }
              }
            }
          }
          e.innerHTML = "收藏";
        }
      }



    </script>
    <script>

      function delete_child_element(parent_element){
        let parent_place = document.getElementsByClassName(parent_element)[0];
        console.log(parent_place)
        while (parent_place.hasChildNodes()) {
          parent_place.removeChild(parent_place.lastChild);
        }
      }

      function render_user_all_lists_name(){

        //有使用者 token 才執行下列動作
        if(localStorage.getItem("access_token")){
          let xhrt= new XMLHttpRequest();
          xhrt.open("post", "/api/user/map_list/result");  
          xhrt.setRequestHeader('Content-Type', 'application/json');
          

          let list_data ={
            type :"select",
            data : {access_token:localStorage.getItem("access_token")}
          };

          //localStorage.getItem("access_token")
          xhrt.send(JSON.stringify(list_data));
          xhrt.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_list_data = JSON.parse(xhrt.response);
              if(user_list_data.error){
                  alert(user_list_data.error);
              }else{
                
                console.log(user_list_data);

                delete_child_element("user_own_list_content");
                let user_own_list_content = document.getElementsByClassName("user_own_list_content")[0];

                let my_list_explain_arrow = document.createElement("img");
                my_list_explain_arrow.src= "/img/arrow.png"
                my_list_explain_arrow.className = "my_list_explain_arrow";
                user_own_list_content.appendChild(my_list_explain_arrow);


                let my_list_explain = document.createElement("p");
                my_list_explain.innerHTML= "開始建立自己的清單吧!"
                my_list_explain.className = "my_list_explain";
                user_own_list_content.appendChild(my_list_explain);

                if(user_list_data.length > 0){
                  delete_child_element("user_own_list_content");

                  for (let i = 0 ;i<user_list_data.length;i++){
                    //製作每一個 list 的內容 img p
                    let user_own_list_content = document.getElementsByClassName("user_own_list_content")[0];
                    let user_every_list_container = document.createElement("div");
                    user_every_list_container.className = "user_every_list_container";
                    user_own_list_content.appendChild(user_every_list_container);

                    let user_list_icon = document.createElement("img");
                    user_list_icon.className = "user_list_icon";
                    user_list_icon.src = `/img/${user_list_data[i].list_icon}.png`
                    user_every_list_container.appendChild(user_list_icon);

                    let user_list_name = document.createElement("p");
                    user_list_name.className = "user_list_name";
                    user_list_name.id = `${user_list_data[i].list_id}`;
                    user_list_name.setAttribute("onClick", "open_a_list(this)");
                    user_list_name.innerHTML = user_list_data[i].list_name;
                    user_every_list_container.appendChild(user_list_name);

                    let label = document.createElement("label");
                    label.className = "switch";
                    user_every_list_container.appendChild(label);

                    let input = document.createElement("input");
                    input.className = "switch_toggle";
                    input.type = "checkbox";
                    if(user_list_data[i].appear_list == "true"){
                      input.checked = true;
                    }
                    input.setAttribute("onclick","appear_list_or_not(this)")
                    label.appendChild(input);

                    let span = document.createElement("span");
                    span.className = "slider round";
                    label.appendChild(span);
                  }
                }

                
              }
                
            }
          }
        }
      }
      
      function render_a_list_all_place_name(list){


        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/place");  
        xhr.setRequestHeader('Content-Type', 'application/json');

        let list_data = {
          type:"select",
          data:list
        }

        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_place_data = JSON.parse(xhr.response);
            if(user_place_data.error){
                alert(user_place_data.error);
            }else{
              console.log(user_place_data);

              let a_list_content = document.getElementsByClassName("a_list_content")[0];

              if(user_place_data.length == 0){
                let a_list_explain = document.createElement("p");
                a_list_explain.className = "a_list_explain";
                a_list_explain.innerHTML = "此清單尚未收藏地點";
                a_list_content.appendChild(a_list_explain);

                let a_list_explain_1 = document.createElement("p");
                a_list_explain_1.className = "a_list_explain";
                a_list_explain_1.innerHTML = "點選喜歡的地標，開始收藏吧";
                a_list_content.appendChild(a_list_explain_1);



              }else{
                //製作新的 place 的內容 p
                for(let i =0; i<user_place_data.length ; i++){     

                  let user_place_container = document.createElement("div");
                  user_place_container.className = "user_place_container";
                  a_list_content.appendChild(user_place_container);

                  let new_place_name = document.createElement("p");
                  new_place_name.className = "user_place_name";
                  new_place_name.id = user_place_data[i].longitude+"_"+user_place_data[i].latitude+"_"+user_place_data[i].place_order
                  new_place_name.innerHTML = user_place_data[i].place_name;
                  new_place_name.setAttribute("onClick", "change_center_to_place(this)");
                  user_place_container.appendChild(new_place_name);

                  let user_delete_place = document.createElement("p");
                  user_delete_place.className = "user_delete_place";
                  user_delete_place.innerHTML = "&times;";
                  user_delete_place.setAttribute("onClick", "delete_user_place(this)");
                  user_place_container.appendChild(user_delete_place);
                }
              }
              console.log("顯示地點列表完成")
            }
              
          }
        }

      }

      function render_map_and_user_all_place(){

        let xhr = new XMLHttpRequest();
          xhr.open("post", `/api/map`);
          xhr.setRequestHeader('Content-Type', 'application/json');

          let list_data = {
            type:"select",
            data:{
              access_token : localStorage.getItem("access_token")
            }
          }
          
          xhr.send(JSON.stringify(list_data));
          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let all_markers = JSON.parse(xhr.responseText);
              console.log(all_markers);

              infoWindow = new google.maps.InfoWindow();
              oms = new OverlappingMarkerSpiderfier(map, {
                markersWontMove: true,
                markersWontHide: true,
                // basicFormatEvents: true,
                nearbyDistance : 1,
                circleSpiralSwitchover : Infinity,
                circleFootSeparation : 50
              });

              // all_marker_data
              for (let i = 0 ; i<all_markers.places.length ;i++){
                let marker = new google.maps.Marker({
                  position:{lat: Number(all_markers.places[i].latitude), lng: Number(all_markers.places[i].longitude)},
                  icon: {
                    url: `/img/${all_markers.places[i].place_icon}.png`//,
                    //scaledSize: new google.maps.Size(30, 30)  //調整大小
                  },
                  zIndex: -1,
                  map:map
                });

                //資訊是空的時候，不要顯示 null
                if(all_markers.places[i].information == null){
                  all_markers.places[i].information="";
                }

                // id = i 是用位置坐定位，當知道每個地點的順序後，因為公用地點的數量不會變，所以可以用位置來決定哪個地點 null
                marker.content = `
                  <div class = "infowindow_container">
                    <h1 class ="infowindow_title" id =${i}>${all_markers.places[i].name}</h1>
                    <p class ="infowindow_content">${all_markers.places[i].information}</p>
                    <br>
                    <buttom class = "choice_list" id =${all_markers.places[i].latitude}_${all_markers.places[i].longitude} style="cursor:pointer" onclick="select_list(this)">收藏</buttom>
                  </div>
                `;                

                //定義每個地標屬於的分類
                marker.category = all_markers.places[i].category;
                //定義每個地標屬於的地名
                marker.name = all_markers.places[i].name;


                oms.addMarker(marker);
                google.maps.event.addListener(marker, 'spider_click', function () {

                  infoWindow.setContent(this.content);
                  infoWindow.open(this.getMap(), this);
                  
                  close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
                });
                
                markers.push(marker);

                if(marker.category.includes("廢棄物處理場") || marker.category.includes("環境教育機構") || marker.category.includes("休閒農場")|| marker.category.includes("健康服務中心")|| marker.category.includes("藝文館所") || marker.category.includes("運動中心")){
                  marker.setVisible(true);
                }else{
                  marker.setVisible(false);  //先隱藏 看不到地標
                }
                
              }
              
              

              render_user_all_place (all_markers.user_places);
              
            }
          }
      }
      
      function render_collection_list_or_not(list){
        let xhrt= new XMLHttpRequest();
        xhrt.open("post", "/api/user/map_list/result");  
        xhrt.setRequestHeader('Content-Type', 'application/json');

        xhrt.send(JSON.stringify(list));
        xhrt.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhrt.response);
            if(user_list_data.error){
                alert(user_list_data.error);
            }else{
              console.log(user_list_data);

              let a_place_content = document.getElementsByClassName("a_place_content")[0];

              if(user_list_data.length ==0){
                let a_place_explain = document.createElement("p");
                a_place_explain.className = "a_place_explain";
                a_place_explain.innerHTML = "噢不，目前沒有清單可以收藏";
                a_place_content.appendChild(a_place_explain);

                let a_place_explain_1 = document.createElement("p");
                a_place_explain_1.className = "a_place_explain";
                a_place_explain_1.innerHTML = "趕緊建立一個新的清單吧";
                a_place_content.appendChild(a_place_explain_1);


              }else{
                for (let i = 0 ;i<user_list_data.length;i++){
                //製作每一個 list 的內容 p
                let list_cotainer = document.createElement("div");
                list_cotainer.className = "list_cotainer"
                a_place_content.appendChild(list_cotainer);

                let list_icon = document.createElement("img");
                list_icon.src = `/img/${user_list_data[i].list_icon}.png`
                list_cotainer.appendChild(list_icon);

               
                let new_list_name = document.createElement("p");
                new_list_name.className = "user_list";
                new_list_name.id = `${user_list_data[i].list_id}`;
                new_list_name.setAttribute("onClick", "open_a_list(this)");
                new_list_name.innerHTML = user_list_data[i].list_name;
                list_cotainer.appendChild(new_list_name);

                let collection_button = document.createElement("button");
                collection_button.className = "collection_button";
                if(user_list_data[i].check_place_is_exist == "true"){
                  collection_button.innerHTML = "移除";
                }else{
                  collection_button.innerHTML = "收藏";
                }
                collection_button.setAttribute("onClick", "store_place_in_list(this)");
                list_cotainer.appendChild(collection_button);
                
              }
              }

              
            } 
          }
        }
      }

      function render_user_all_place (user_all_place){

        for (let i = 0 ; i<user_all_place.length ;i++){
                
          let marker = new google.maps.Marker({
            position:{lat: Number(user_all_place[i].latitude), lng: Number(user_all_place[i].longitude)},
            icon: {
              url: `/img/${user_all_place[i].list_icon}.png`
              //scaledSize: new google.maps.Size(50, 50)  //調整大小
            },
            zIndex: -1,
            map:map
          });

          //資訊是空的時候，不要顯示 null
          if(user_all_place[i].information == null){
            user_all_place[i].information="";
          }

          marker.content = `
            <div class = "infowindow_container">
              <h1 class ="infowindow_title" id =${user_all_place[i].place_order}>${user_all_place[i].place_name}</h1>
              <p class ="infowindow_content" id = ${i}>${user_all_place[i].information}</p>
              <br>
              <buttom class = "choice_list" id =${user_all_place[i].latitude}_${user_all_place[i].longitude} style="cursor:pointer" onclick="select_list(this)">已收藏</buttom>
            </div>
          `;
          
          //定義每個地標屬於的清單
          marker.list = user_all_place[i].list_name
          //定義每個地標屬於的地名
          marker.name = user_all_place[i].place_name;

          oms.addMarker(marker);
          google.maps.event.addListener(marker, 'spider_click', function () {                   

            console.log(marker);
            console.log(marker.icon);
            console.log(marker.icon.url);
            console.log(marker.list);

            infoWindow.setContent(this.content);
            infoWindow.open(this.getMap(), this);

            close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
          });
          markers[user_all_place[i].place_order].setMap(null); //將相對應的公用地點 隱藏
          user_markers.push(marker);

          //如果是隱藏的清單要隱藏，並讓公用地點回復原狀
          if(user_all_place[i].appear_list == "false"){
            user_markers.map(item=>{
              if(item.list == user_all_place[i].list_name){
                item.setMap(null);
                markers[user_all_place[i].place_order].setMap(map);
              }
            });
          }
          
        }

        google.maps.event.addListener(map, 'click', function () { 
          infoWindow.close();
          close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
          search_marker.setMap(null); //使用者點擊其他地方時關掉紅色的搜尋地標
        });


        
      }

      function open_slidebar() {

        close_slidebar();

        document.getElementById("search_list_and_place").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";
        document.getElementById("open_bar").style.marginLeft = "300px";
        document.getElementById("close_bar").style.marginLeft = "300px";
        document.getElementById("open_search_bar").style.marginLeft = "300px";

        //使用者跳出公開單一清單頁面時，要把座標跟值隱藏掉，所以在返回清單搜尋時要把值設回預設，不要顯示公開清單的地點
        user_public_list_markers.map(item=>{item.setMap(null)});
        user_public_list_markers=[];
        switch_for_public_list_map=1;

      }

      function open_user_list_bar() {
        close_slidebar();

        document.getElementById("user_own_list").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";
        document.getElementById("open_bar").style.marginLeft = "300px";
        document.getElementById("close_bar").style.marginLeft = "300px";
        document.getElementById("open_search_bar").style.marginLeft = "300px";

        //使用者跳出公開單一清單頁面時，要把座標跟值隱藏掉，所以在返回清單搜尋時要把值設回預設，不要顯示公開清單的地點
        user_public_list_markers.map(item=>{item.setMap(null)});
        user_public_list_markers=[];
        switch_for_public_list_map=1;

      }

      function close_slidebar() {
        document.getElementById("search_list_and_place").style.width = "0";
        document.getElementById("a_public_list").style.width = "0";
        document.getElementById("a_list").style.width = "0";
        document.getElementById("a_place").style.width = "0";
        document.getElementById("user_own_list").style.width = "0";

        document.getElementById("map").style.marginLeft= "0";
        document.getElementById("open_bar").style.marginLeft = "0";
        document.getElementById("close_bar").style.marginLeft = "0";
        document.getElementById("open_search_bar").style.marginLeft = "0";
      }

      function open_list_input() {
        if(localStorage.getItem("access_token")== undefined){
          alert("! 欲使用此功能，請先登入");
        }else{
          document.getElementById("input_list_name").style.width = "100%";
        }
        
      }

      function open_list_edit(e) {
        if(localStorage.getItem("access_token")== undefined){
          alert("! 欲使用此功能，請先登入");
        }else{
          document.getElementById("edit_list_name").style.width = "100%";
          document.getElementById("list_name_edit").value = e.parentElement.children[1].innerHTML;
        }
        
      }

      function close_list_input_and_edit() {
        document.getElementById("input_list_name").style.width = "0";
        document.getElementById("edit_list_name").style.width = "0";
      }

      function close_a_place_slidebar(){
        document.getElementById("a_place").style.width = "0px";

        // if (document.getElementById("a_public_list").style.width == "" && document.getElementById("a_list").style.width == "" && document.getElementById("search_list_and_place").style.width == "" && document.getElementById("user_own_list").style.width == ""){
        //   document.getElementById("map").style.marginLeft = "0";
        //   document.getElementById("open_bar").style.marginLeft = "0";
        //   document.getElementById("close_bar").style.marginLeft = "0";
        //   document.getElementById("open_search_bar").style.marginLeft = "0";
        // }

        if (document.getElementById("a_public_list").style.width == "0px" && document.getElementById("a_list").style.width == "0px" && document.getElementById("search_list_and_place").style.width == "0px" && document.getElementById("user_own_list").style.width == "0px"){
          document.getElementById("map").style.marginLeft = "0px";
          document.getElementById("open_bar").style.marginLeft = "0";
          document.getElementById("close_bar").style.marginLeft = "0";
          document.getElementById("open_search_bar").style.marginLeft = "0";
          }

      }
      
      function reset_input(){
        document.querySelector('#list_name').value="";
        document.getElementById("reset").checked = true;
      }

      function send_list_name(){

        let insert_list ={
          category : document.querySelector('input[name="category"]:checked').value,
          list_name : document.getElementsByName("list_name")[0].value,
          list_icon : document.querySelector('input[name="pattern"]:checked').value,
          access_token : localStorage.getItem("access_token")
        }

        if (insert_list.list_name == "" || insert_list.list_name == undefined){
          alert("! 請輸入清單名稱");
          return;
        }

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"create",
          data:insert_list
        }

        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhr.response);
            if(user_list_data.error){
              alert(user_list_data.error);
            }else{
              
              console.log(user_list_data);
              
              delete_child_element("user_own_list_content")
              render_user_all_lists_name();
              close_list_input_and_edit();
              reset_input();
            }
              
          }
        }
      }

      function send_edit_list_name(){

        let list_name_edit = document.getElementById("list_name_edit")

        let update_list ={
          list_id : document.getElementsByClassName("a_list_title")[0].id,
          category : document.querySelector('input[name="edit_category"]:checked').value,
          list_icon : document.querySelector('input[name="edit_pattern"]:checked').value,
          access_token : localStorage.getItem("access_token")
        }

        if(document.getElementsByClassName("a_list_title")[0].innerHTML != document.getElementsByName("list_name_edit")[0].value){
          update_list.list_name=document.getElementsByName("list_name_edit")[0].value;
        }
        console.log(document.getElementsByName("list_name_edit")[0].value)
        if (document.getElementsByName("list_name_edit")[0].value == ""){
          alert("! 請輸入清單名稱");
          return;
        }

        let xhr = new XMLHttpRequest();

        xhr.open("post", "/api/user/map_list");  
        xhr.setRequestHeader('Content-Type', 'application/json');

        let list_data = {
          type:"update",
          data:update_list
        }
        console.log(list_data)
        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhr.response);
            if(user_list_data.error){
              alert(user_list_data.error);
            }else{
              console.log(user_list_data);
              delete_child_element("user_own_list_content");
              render_user_all_lists_name();
              close_list_input_and_edit();

              // 只改變被編輯後的清單
              user_markers.map(item=>{
                if(item.list == user_list_data.data[0].list_name){
                  console.log(user_list_data.data[0].list_name)
                  item.setMap(null);
                  item.icon.url = `/img/${user_list_data.data[0].list_icon}.png`
                  item.setMap(map);
                }
              });
              //想到上面的方法了 所以這段先放著
              // markers.map(item=>{item.setMap(null)})//同下下
              // markers=[]; //因為下一步要重新顯示 ，所以 markers 要先清空，才不會重複算
              // user_markers.map(item=>{item.setMap(null)}); //不先 null 掉的話，顯示時會被刪除的點依舊存在
              // user_markers = []; //同上上
              // render_map_and_user_all_place();

              //最後改完名字 跟 地標 要同步顯示
              document.getElementsByClassName("a_list_title")[0].innerHTML = document.getElementsByName("list_name_edit")[0].value
              document.getElementsByClassName("user_a_list_icon")[0].src = `/img/${update_list.list_icon}.png`
            }
              
          }
        }
      }

      function open_a_list(e) {
        console.log(e)
        
        let new_a_list_name = document.getElementsByClassName("a_list_title")[0];
        new_a_list_name.innerHTML="";

        delete_child_element("a_list_content");

        close_slidebar();

        document.getElementById("a_list").style.width = "300px";
        document.getElementById("map").style.marginLeft = "300px";
        document.getElementById("open_bar").style.marginLeft = "300px";
        document.getElementById("close_bar").style.marginLeft = "300px";
        document.getElementById("open_search_bar").style.marginLeft = "300px";
     
        new_a_list_name.id = e.id;
        new_a_list_name.className = "a_list_title";
        new_a_list_name.innerHTML = e.innerHTML;

        let user_a_list_icon = document.getElementsByClassName("user_a_list_icon")[0];
        user_a_list_icon.src = e.parentElement.children[0].src;

        let select_place ={
          access_token : localStorage.getItem("access_token"),
          list_name : e.innerHTML
        }
        console.log(select_place);

        render_a_list_all_place_name(select_place);

      }

      function confirm_delete() {
        let remove = confirm("確定是否刪除此清單?");
        if(remove == true){
          delete_a_list();
        }
      }

      function delete_a_list(){
        let a_list_title = document.getElementsByClassName("a_list_title")[0];
        console.log(a_list_title)
        console.log(a_list_title.innerHTML)
        
        let delete_list ={
          list_id : a_list_title.id,
          list_name : a_list_title.innerHTML,
          access_token : localStorage.getItem("access_token")
        }

        let xhr = new XMLHttpRequest();

        xhr.open("post", "/api/user/map_list");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"delete",
          data:delete_list
        }
        console.log(list_data)
        xhr.send(JSON.stringify(list_data));
        
        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhr.response);
            if(user_list_data.error){
              alert(user_list_data.error);
            }else{
              
              console.log(user_list_data);

              close_slidebar();

              delete_child_element("user_own_list_content");

              render_user_all_lists_name();

              //將刪除的清單隱藏後，顯示那些原本被隱藏的公用地點
              user_markers.map(item=>{
                if(item.list == user_list_data.data[0].list_name){
                  console.log(user_list_data.data[0].list_name)
                  item.setMap(null);
                }
              });
              for(let i = 0 ; i< user_list_data.data.length ; i++){
                // ==0 代表沒有其他點了，所以可以顯示
                if(user_list_data.data[i].place_is_exist == 0){
                  markers[user_list_data.data[i].place_order].setMap(map);
                }
               
              }


              // markers.map(item=>{item.setMap(null)})//同下下
              // markers=[]; //因為下一步要重新顯示 ，所以 markers 要先清空，才不會重複算
              // user_markers.map(item=>{item.setMap(null)}); //不先 null 掉的話，顯示時會被刪除的點依舊存在
              // user_markers = []; //同上上
              // render_map_and_user_all_place();
              

            } 
          }
        }

      }
     
      function appear_list_or_not(e){

        let list_name = e.parentElement.parentElement.children[1].innerHTML;
        let list_id = e.parentElement.parentElement.children[1].id;

        let update_list ={
          list_id : list_id,
          list_name :list_name,
          appear_list : e.checked,
          access_token : localStorage.getItem("access_token")
        }

        let xhr = new XMLHttpRequest();

        xhr.open("post", "/api/user/map_list");  
        xhr.setRequestHeader('Content-Type', 'application/json');

        let list_data = {
          type:"update_appear",
          data:update_list
        }
        console.log(list_data)
        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_list_data = JSON.parse(xhr.response);
            if(user_list_data.error){
              alert(user_list_data.error);
            }else{
              console.log(user_list_data);


              if(user_list_data.success == "update false"){
                //將選到的清單隱藏後，顯示那些原本被隱藏的公用地點
                user_markers.map(item=>{
                  if(item.list == user_list_data.data[0].list_name){
                    //console.log(user_list_data.data[0].list_name)
                    item.setMap(null);
                  }
                });

                for(let i = 0 ; i< user_list_data.data.length ; i++){
                  // ==0 代表沒有其他點了，所以可以顯示
                  if(user_list_data.data[i].place_is_exist == 0){
                    markers[user_list_data.data[i].place_order].setMap(map);
                  }
                  
                }
              }else{
                //抓出使用者的地標，從後面開始抓，理論上最後面的是最新的，也避免刪掉的點 再次顯示的問題
                for(let i = 0; i <user_list_data.data.length  ; i++){
                  // console.log("清單的點",user_list_data.data[i].place_name)
                  for(let j = user_markers.length-1 ; j >= 0 ; j--){
                    // console.log("要消失的的點",user_markers[j].name)
                    if(user_markers[j].name == user_list_data.data[i].place_name && user_markers[j].list == user_list_data.data[i].list_name){
                      //console.log(user_list_data.data[0].list_name)
                      console.log("要消失的的點",user_markers[j].name,user_markers[j].list)
                      user_markers[j].setMap(map);
                      break;
                    }
                  }
                }

                //公用地點要隱藏
                for(let i = 0 ; i< user_list_data.data.length ; i++){
                  markers[user_list_data.data[i].place_order].setMap(null);
                }
              }



              //因為想到上面的方法，這邊先保留
              // markers.map(item=>{item.setMap(null)})//同下下
              // markers=[]; //因為下一步要重新顯示 ，所以 markers 要先清空，才不會重複算
              // user_markers.map(item=>{item.setMap(null)}); //不先 null 掉的話，顯示時會被刪除的點依舊存在
              // user_markers = []; //同上上
              // render_map_and_user_all_place();
            }
              
          }
        }



      }

      let switch_for_public_list_map;
      let user_public_list_markers=[];
      function show_and_open_public_list(e){

        console.log(e);

        //close_slidebar();
        
        if(switch_for_public_list_map !=0){
          
          let select_one_list={
            list_id:e.id,
            list_name:e.innerHTML
          }

          let xhr = new XMLHttpRequest();
          xhr.open("post", "/api/user/map_list/show/list");  
          xhr.setRequestHeader('Content-Type', 'application/json');
          
          let list_data = {
            type:"select",
            data:select_one_list
          }

          xhr.send(JSON.stringify(list_data));

          xhr.onreadystatechange=function() {
            if (this.readyState == 4 && this.status == 200) {
              let user_place_data = JSON.parse(xhr.response);
              if(user_place_data.error){
                  alert(user_place_data.error);
              }else{
                //確定結果無誤再打開 slidebar 比較好
                document.getElementById("a_public_list").style.width = "300px";
                document.getElementById("map").style.marginLeft = "300px";
                document.getElementById("open_bar").style.marginLeft = "300px";
                document.getElementById("close_bar").style.marginLeft = "300px";
                document.getElementById("open_search_bar").style.marginLeft = "300px";

                console.log(user_place_data);

                //let a_public_list_name = document.getElementById("a_public_list_name");

                let public_list_name = document.querySelector("#a_public_list_name >p");

                public_list_name.innerHTML = e.innerHTML;
                public_list_name.id =e.id;
                public_list_name.setAttribute("onclick","show_and_open_public_list(this)")

                delete_child_element("a_public_list_content");
                
                //製作新的public place 的內容 p
                let parent_place = document.getElementsByClassName("a_public_list_content")[0];


                if(user_place_data.user_list_place.length == 0){
                  let new_place_name = document.createElement("p");
                  new_place_name.className = "no_content_in_list"
                  new_place_name.innerHTML = "噢不，該使用者尚未收藏地點";
                  parent_place.appendChild(new_place_name);

                  let new_place_name_1 = document.createElement("p");
                  new_place_name_1.className = "no_content_in_list"
                  new_place_name_1.innerHTML = "再看看其他人的清單吧";
                  parent_place.appendChild(new_place_name_1);


                  return;
                }
                
                for(let i =0; i<user_place_data.user_list_place.length ; i++){     
                  let new_place_name = document.createElement("p");
                  new_place_name.className = "user_place_name";
                  new_place_name.innerHTML = user_place_data.user_list_place[i].place_name;
                  new_place_name.id = user_place_data.user_list_place[i].longitude+"_"+user_place_data.user_list_place[i].latitude
                  new_place_name.setAttribute("onClick", "change_center_to_place(this)");
                  parent_place.appendChild(new_place_name);
                }


                infoWindow = new google.maps.InfoWindow();
                for(let i =0 ; i< user_place_data.user_list_place.length;i++){
                  //顯示公開的使用者的收藏地點
                  let marker = new google.maps.Marker({
                    position:{lat: Number(user_place_data.user_list_place[i].latitude), lng: Number(user_place_data.user_list_place[i].longitude)},
                    icon: {
                    url: `/img/point.png`
                    },
                    animation: google.maps.Animation.DROP,
                    zIndex: 5,
                    map:map
                  });

                  //資訊是空的時候，不要顯示 null
                  if(user_place_data.user_list_place[i].information == null){
                    user_place_data.user_list_place[i].information="";
                  }

                  marker.content = `
                    <div class = "infowindow_container">
                      <h1 class ="infowindow_title">${user_place_data.user_list_place[i].place_name}</h1>
                      <p class ="infowindow_content">${user_place_data.user_list_place[i].information}</p>
                    </div>
                  `;

                  user_public_list_markers.push(marker);
                  oms.addMarker(marker);
                  google.maps.event.addListener(marker, 'spider_click', function () {                   
                    infoWindow.setContent(this.content);
                    infoWindow.open(this.getMap(), this);
                  });

                  
                  google.maps.event.addListener(map, 'click', function () { 
                    infoWindow.close();
                  });
                }
                
              }
            }
          }

          switch_for_public_list_map=0;
        }else{
          //使用者時，要把座標跟值隱藏掉，所以在返回清單搜尋時要把值設回預設，不要顯示公開清單的地點
          user_public_list_markers.map(item=>{item.setMap(null)});
          user_public_list_markers=[];
          switch_for_public_list_map=1;
        }





      }

      function copy_other_list(e){
        console.log(e);

        if(localStorage.getItem("access_token")== undefined){
          alert("! 欲使用此功能，請先登入");
          return;
        }

        let a_public_list_name = e.parentElement.children[1];

        console.log(a_public_list_name);

        let copy_list={
          access_token : localStorage.getItem("access_token"),
          list_id : a_public_list_name.id,
          list_name : a_public_list_name.innerHTML
        }
        console.log(copy_list);

        let xhr = new XMLHttpRequest();
        xhr.open("post", "/api/user/map_list/copy");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let list_data = {
          type:"copy",
          data:copy_list
        }

        xhr.send(JSON.stringify(list_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            let user_place_data = JSON.parse(xhr.response);
            if(user_place_data.error){
              alert(user_place_data.error);
            }else{
             
              console.log(user_place_data);
              alert("複製成功");
              delete_child_element("user_own_list_content");
              render_user_all_lists_name();
              render_user_all_place (user_place_data.data);

            }
              
          }
        }

      }

      function change_center_to_place(e){

        //清除上一個顯示的地點
        if(search_marker){
          search_marker.setMap(null);
        }

        console.log(e)
        map.setZoom(15);

        map.panTo({lat: Number(e.id.split("_")[1]), lng: Number(e.id.split("_")[0])});

        search_marker = new google.maps.Marker({
          position:{lat: Number(e.id.split("_")[1]), lng: Number(e.id.split("_")[0])},
          icon: {
            url: `/img/point2.png`,
            zIndex: 10
            //scaledSize: new google.maps.Size(50, 50)  //調整大小
          },
          //animation: google.maps.Animation.DROP,
          map:map
        });
        

        search_marker.content = `
        <div class = "infowindow_container">
          <h1 class ="infowindow_title" id = ${e.id.split("_")[2]} >${e.innerHTML}</h1>
          <br>
          <buttom class = "choice_list" id =${e.id.split("_")[1]}_${e.id.split("_")[0]} style="cursor:pointer" onclick="select_list(this)">收藏</buttom>
        </div>
        `;
        

        let search_place_infoWindow = new google.maps.InfoWindow();

        //直接顯示資訊
        search_place_infoWindow.setContent(search_marker.content);
        search_place_infoWindow.open(search_marker.getMap(), search_marker);

        google.maps.event.addListener(search_marker, 'click', function () {

          search_place_infoWindow.setContent(this.content);
          search_place_infoWindow.open(this.getMap(), this);

          close_a_place_slidebar(); //使用者點擊其他地方時關掉地點收藏的畫面
        });

      }

      // 選擇不同模式下 input 的 placeholder 會改變
      function switch_for_search_condition (){
       
        let search_condition = document.getElementsByClassName("checkbox")[0];

        if(search_condition.checked == false){
          document.getElementById("search_list_and_place_input").placeholder = "搜尋他人清單"
        }else{
          document.getElementById("search_list_and_place_input").placeholder = "搜尋地點"
        }

      }
 
      render_user_all_lists_name();

    </script>
</head>
<body>
  <div class = "main" >
    <nav>
      <div>
        <a href="/">
          <p id="logo" class="Logo">mapBook</p>
        </a>
      </div>
    
      <div>
        <ul>
          <!-- <li class = "search_place_input">
            <div class="searchBox">
              <input id="search_place" class="searchInput" type="text" name="" placeholder="搜尋地點" autocomplete="off">
              <button class="searchButton" onclick="change_search_place_input_width()">
             
              </button>

              <div class = "search_place_result" id = "search_place_result">
              </div>

            </div>
          </li> -->
          <li class="nav_item"><a href="/">About</a></li>
          <li class="nav_item"><a href="/main_map.html">Explore</a></li>
          <li class="nav_item" onclick="signin_or_out()"><a></a></li>
        </ul>
      </div>
    </nav>


    <!-- 畫面外的新增清單 -->
    <div id="input_list_name" class="input_list_name">
      <a href="javascript:void(0)" class="close_button" onclick="close_list_input_and_edit()">&times;</a>
      <input type="radio" name="category" value="true" checked > 公開 (可在搜尋列搜尋到您的清單)<br>
      <input type="radio" name="category" value="false"> 私人 (搜尋列無法搜尋到您的清單)<br>
      <input type="text" id = "list_name" name="list_name" placeholder="請輸入清單名稱" autocomplete="off"><br>
      <div>
        <p style="margin-bottom: 15px;">清單地標樣式選擇</p>
        <input type="radio" id = "reset" name="pattern" value="red" checked ><img src ="/img/red.png">
        <input type="radio" name="pattern" value="aqua" ><img src ="/img/aqua.png">
        <input type="radio" name="pattern" value="black" ><img src ="/img/black.png">
        <input type="radio" name="pattern" value="blue" ><img src ="/img/blue.png"><br>
        <input type="radio" name="pattern" value="fuchsia" ><img src ="/img/fuchsia.png">
        <input type="radio" name="pattern" value="gray" ><img src ="/img/gray.png">
        <input type="radio" name="pattern" value="green" ><img src ="/img/green.png">
        <input type="radio" name="pattern" value="lime" ><img src ="/img/lime.png"><br>
        <input type="radio" name="pattern" value="maroon" ><img src ="/img/maroon.png">
        <input type="radio" name="pattern" value="navy" ><img src ="/img/navy.png">
        <input type="radio" name="pattern" value="olive" ><img src ="/img/olive.png">
        <input type="radio" name="pattern" value="purple" ><img src ="/img/purple.png"><br>
        <input type="radio" name="pattern" value="silver" ><img src ="/img/silver.png">
        <input type="radio" name="pattern" value="teal" ><img src ="/img/teal.png">
        <input type="radio" name="pattern" value="white" ><img src ="/img/white.png">
        <input type="radio" name="pattern" value="yellow" ><img src ="/img/yellow.png">
      </div>
      <button type="submit" onclick="send_list_name()")>完成</button>
    </div>
    <!-- 畫面外的介面結束 -->

    <!-- 畫面外的編輯清單 -->
    <div id="edit_list_name" class="edit_list_name">
      <a href="javascript:void(0)" class="close_button" onclick="close_list_input_and_edit()">&times;</a>
      <input type="radio" name="edit_category" value="true" checked > 公開<br>
      <input type="radio" name="edit_category" value="false"> 私人<br>
      <input type="text" id = "list_name_edit" name="list_name_edit" placeholder="請輸入清單名稱" autocomplete="off"><br>
      <div>
        <p style="margin-bottom: 15px;">清單地標樣式選擇</p>
        <input type="radio" id = "edit_reset" name="edit_pattern" value="red" checked ><img src ="/img/red.png">
        <input type="radio" name="edit_pattern" value="aqua" ><img src ="/img/aqua.png">
        <input type="radio" name="edit_pattern" value="black" ><img src ="/img/black.png">
        <input type="radio" name="edit_pattern" value="blue" ><img src ="/img/blue.png"><br>
        <input type="radio" name="edit_pattern" value="fuchsia" ><img src ="/img/fuchsia.png">
        <input type="radio" name="edit_pattern" value="gray" ><img src ="/img/gray.png">
        <input type="radio" name="edit_pattern" value="green" ><img src ="/img/green.png">
        <input type="radio" name="edit_pattern" value="lime" ><img src ="/img/lime.png"><br>
        <input type="radio" name="edit_pattern" value="maroon" ><img src ="/img/maroon.png">
        <input type="radio" name="edit_pattern" value="navy" ><img src ="/img/navy.png">
        <input type="radio" name="edit_pattern" value="olive" ><img src ="/img/olive.png">
        <input type="radio" name="edit_pattern" value="purple" ><img src ="/img/purple.png"><p>
        <input type="radio" name="edit_pattern" value="silver" ><img src ="/img/silver.png">
        <input type="radio" name="edit_pattern" value="teal" ><img src ="/img/teal.png">
        <input type="radio" name="edit_pattern" value="white" ><img src ="/img/white.png">
        <input type="radio" name="edit_pattern" value="yellow" ><img src ="/img/yellow.png">
      </div>
      <button type="submit" onclick="send_edit_list_name()")>完成</button>
    </div>
    <!-- 畫面外的介面結束 -->




    <div class = "public_map" >

      <button id ="open_bar" style="font-size:30px;cursor:pointer" onclick="open_user_list_bar()" >></button>
      <button id ="close_bar" style="font-size:30px;cursor:pointer" onclick="close_slidebar()" >&times;</button>
      <button id ="open_search_bar" style="font-size:30px;cursor:pointer" onclick="open_slidebar()">&nbsp;</button>

      <!-- 畫面外的使用者單一清單介面  -->
      <div id ="a_list" class="a_list">
        <div id = "a_list_name" class="a_list_name">
          <img class="user_a_list_icon">
          <p class="a_list_title" ></p>
          <img class="a_list_edit_icon" src="img/edit.png" onclick="open_list_edit(this)">
          <img class="a_list_delete_icon" src="img/remove.png" onclick="confirm_delete()">
        </div>
        <div class="a_list_content">
  
        </div>
      </div>
      <!-- 畫面外的介面結束 -->

      <!-- 畫面外的他人單一清單介面  -->
      <div id ="a_public_list" class="a_list">
        <div id = "a_public_list_name" class="a_list_name">
          <img class= "public_icon" src="img/point.png">
          <p class="a_public_list_title" ></p>
          <img src="img/copy.png" class="copy_img" onclick="copy_other_list(this)">
        </div>
        <div class="a_public_list_content">
  
        </div>
      </div>
      <!-- 畫面外的介面結束 -->

      <!-- 畫面外的單一地點介面  -->
      <div id ="a_place" class="a_place">
        <div id = "a_place_name" class="a_place_name">
          <p class="a_place_title" ></p>
        </div>
        <div class="a_place_content">
  
        </div>
      </div>
      <!-- 畫面外的介面結束 -->

      <!-- 畫面外的使用者所有清單介面  -->
      <div id ="user_own_list" class="user_own_list">
          <div id = "user_own_list_title" class="user_own_list_title">
            <p class="my_list">My Lists</p>
            <img class="creat_new_list" src="/img/add.png" onclick="open_list_input()">
          </div>
          <div class="user_own_list_content">
              <img class="my_list_explain_arrow" src="/img/arrow.png">
            <p class="my_list_explain">登入後點選上方符號</p>
            <p class="my_list_explain">開始建立屬於自己的清單</p>
          </div>
      </div>
      <!-- 畫面外的介面結束 -->



      <div class= "search_list_and_place" id="search_list_and_place">
        <div class = "search_list_and_place_bar">
          <input id = "search_list_and_place_input" placeholder="搜尋他人清單" autocomplete="off">
          <img src="img/search.png" class= "list_and_place_result" onclick="search_list_or_place()">
          <img src="img/delete.png" class= "delete_list_and_place_result" onclick="delete_search_input ()">

          <div class="toggle-button-cover">
            <div class="button-cover">
              <div class="button b2" id="button-10">
                <input type="checkbox" class="checkbox" onclick="switch_for_search_condition ()">
                <div class="knobs">
                  <span>清單</span>
                </div>
                <div class="layer"></div>
              </div>
            </div>
          </div>
        </div>

        <div class = "search_list_and_place_result">
          <br>
          <p class = "search_explain">搜尋說明</p>
          <br>
          <img class = "search_explain_img_1" src="/img/list_example.png">
          <p class = "search_explain">選擇清單，可搜尋他人公開的清單</p>
          <br>
          <img class = "search_explain_img_2" src="/img/place_example.png">
          <p class = "search_explain">選擇地點，可搜尋地址或地名</p>
          
        </div>

      </div>
      
      <div id="map">  
      </div>
      
      
    

    </div>

    <footer>
        <div class="footer_bar">
          <div class="copyright">
              <p>© 2019. All rights reserved.</p>
          </div>
        </div>
    </footer>
  </div>
      

  <script>
    //新增清單，按下按鍵送出
    let list_name = document.getElementById("list_name");
    list_name.addEventListener("keyup", function(event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        send_list_name();
      }
    });

    //搜尋他人清單
    function search_public_list (){
      delete_child_element("search_list_and_place_result");
      let grandpa_list_result = document.getElementsByClassName("search_list_and_place_result")[0];

      let xhr = new XMLHttpRequest();

      xhr.open("post", "/api/user/map_list/search/list");  
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      let list_data = {
        type:"search",
        data:search_list_or_place_input.value
      }
      console.log(list_data)
      xhr.send(JSON.stringify(list_data));

      xhr.onreadystatechange=function() {
        if (this.readyState == 4 && this.status == 200) {
          if(xhr.response == "There is no user data."){
            alert("! 查無此使用者，請註冊");
          }else{
            let user_list_data = JSON.parse(xhr.response);
            console.log(user_list_data);

            if(user_list_data.length == 0){
              let parent_list = document.createElement("p");
              parent_list.className = "no_public_list";
              parent_list.innerHTML = "查無清單，請換關鍵字搜尋"
              grandpa_list_result.appendChild(parent_list);

            }

            for (let i = 0 ;i<user_list_data.length;i++){
              //製作每一個 list 的內容 
              let parent_list = document.createElement("div");
              parent_list.className = "public_list_container";
              grandpa_list_result.appendChild(parent_list);

              let list_name = document.createElement("p");
              list_name.innerHTML = user_list_data[i].list_name;
              list_name.id =user_list_data[i].list_id;
              list_name.className = "public_list";
              list_name.setAttribute("onclick","show_and_open_public_list(this)");
              parent_list.appendChild(list_name);

              let list_copy_number_img = document.createElement("img");
              list_copy_number_img.className = "list_copy_number_img";
              list_copy_number_img.src = "/img/multiple-users-silhouette.png";
              parent_list.appendChild(list_copy_number_img);

              let list_copy_number = document.createElement("p");
              list_copy_number.innerHTML = user_list_data[i].copy_number;
              list_copy_number.className = "list_copy_number";
              parent_list.appendChild(list_copy_number);

              let list_owner = document.createElement("p");
              list_owner.innerHTML = user_list_data[i].user_name;
              list_owner.className = "public_list_owner";
              parent_list.appendChild(list_owner);
    
            }
          }             
        }
      }
    }

    //搜尋地點
    function search_place (){
      delete_child_element("search_list_and_place_result");
        let grandpa_place_result = document.getElementsByClassName("search_list_and_place_result")[0];

        let xhr = new XMLHttpRequest();

        xhr.open("post", "/api/user/map_list/search/place");  
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        let place_data = {
          type:"search",
          data:search_list_or_place_input.value
        }
        console.log(place_data)
        xhr.send(JSON.stringify(place_data));

        xhr.onreadystatechange=function() {
          if (this.readyState == 4 && this.status == 200) {
            if(xhr.response == "There is no user data."){
              alert("! 查無此使用者，請註冊");
            }else{
              let place_data = JSON.parse(xhr.response);
              console.log(place_data);
              console.log(grandpa_place_result);
              grandpa_place_result.removeAttribute("style");

              if(place_data.length == 0){
                let parent_place = document.createElement("p");
                parent_place.className = "no_place_list";
                parent_place.innerHTML = "查無清單，請換關鍵字搜尋"
                grandpa_place_result.appendChild(parent_place);
              }

              for (let i = 0 ;i<place_data.length;i++){
                //製作每一個 place 的內容 
                let parent_place = document.createElement("div");
                parent_place.className = "place_container";
                parent_place.setAttribute("onclick","change_center_to_place(this.children[1].children[0])")
                grandpa_place_result.appendChild(parent_place);

                let place_img = document.createElement("img");
                place_img.className = "place_img";
                place_img.src = "/img/place_search.png"
                parent_place.appendChild(place_img);


                let name_and_address_container = document.createElement("div");
                name_and_address_container.className = "name_and_address_container";
                parent_place.appendChild(name_and_address_container);

                //為了在搜尋列 顯示地點名稱時知道順序 所以只好用迴圈的方式找出該地名的順序
                let marker_order;
                for (let j =0 ; j <markers.length; j++){
                  if(markers[j].name == place_data[i].name){
                    marker_order = j;
                  }
                }

                let place_name = document.createElement("p");
                place_name.innerHTML = place_data[i].name;
                place_name.id =place_data[i].longitude + "_" + place_data[i].latitude + "_" + marker_order;
                place_name.className = "public_place_name";
                //place_name.setAttribute("onclick","change_center_to_place(this)");
                name_and_address_container.appendChild(place_name);

                let place_address = document.createElement("p");
                place_address.innerHTML = place_data[i].address;
                place_address.className = "public_place_address";
                name_and_address_container.appendChild(place_address);

      
              }
            }             
          }
        }
    }

    let search_list_or_place_input = document.getElementById("search_list_and_place_input");
    //搜尋他人清單或是地點
    function search_list_or_place (){
      let search_condition = document.getElementsByClassName("checkbox")[0];
      if(search_condition.checked == false){
        search_public_list ();
      }else{
        search_place ();
      }
    }
    
    //按下按鍵搜尋他人清單或是地點
    search_list_or_place_input.addEventListener("keyup", function(event) {
    // Number 13 is the "Enter" key on the keyboard
      //console.log(search_list_or_place_input)
      if (event.keyCode === 13) {
        event.preventDefault();
        search_list_or_place (); 
      }
    });

    

    
    //刪除 input 的內容及搜尋結果
    function delete_search_input (){
      delete_child_element("search_list_and_place_result");
      document.getElementById("search_list_and_place_input").value = "";
    }
    
  
    //點擊搜尋地址按鈕外的地方，搜尋列會縮回去 //點擊搜尋地址結果外的地方，搜尋結果會關掉
    // let search_place_input = document.getElementById("search_place");
    // function change_search_place_input_width(){
    //   search_place_input.style.width = "260px";
    //   search_place_input.style.padding = "0 6px";
    // }


    //點擊搜尋地址按鈕外的地方，搜尋列會縮回去 //點擊搜尋地址結果外的地方，搜尋結果會關掉
    document.onclick = function(e){
      // console.log(e.target.id);
      // console.log(e.target.className);
      // if((e.target.id !== 'search_place' && e.target.className !== 'searchButton')){
      //   search_place_input.style.width = "0px";
      //   search_place_input.style.padding = "0px";
      // }
      // if(e.target.id !== 'search_place_result'){
      // search_place_result.style.display = 'none';
      // }

      //點擊地圖以外的地方 infoWindow 會關掉
      if(e.target.id || e.target.className){
        infoWindow.close();
      }

    };


   
  </script>
  <script src="js/common.js"></script>
</body>



</html> 